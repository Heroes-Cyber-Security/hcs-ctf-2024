<?php
session_start();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: upload.html');
    exit();
}

if (!isset($_FILES['file'])) {
    die('No file uploaded!');
}

if ($_FILES["file"]["size"] > 500000) {
    die("Sorry, your file is too large. Maximal file size is 500KB.");
}

$file_type = $_FILES['file']['type']; //returns the mimetype

$allowed = array("image/jpeg", "image/gif", "image/png");
if (!in_array($file_type, $allowed)) {
    $error_message = 'Only jpg, gif, and png files are allowed.';

    echo $error_message;

    exit();
}

$target_dir = '../storage/';

$target_file = $target_dir . uniqid() . basename($_FILES['file']['name']);

if (move_uploaded_file($_FILES['file']['tmp_name'], $target_file)) {
    if (!isset($_SESSION['files'])) {
        $_SESSION['files'] = [];
    }

    $_SESSION['files'][] = [
        'name' => htmlspecialchars(basename($target_file)),
        'path' => 'access.php?file=' . urlencode(basename($target_file)),
    ];

    header('Location: files.php');
} else {
    echo 'Sorry, there was an error uploading your file.';
}
